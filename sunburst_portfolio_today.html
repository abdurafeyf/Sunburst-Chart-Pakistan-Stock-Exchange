<!DOCTYPE html>

<html>


<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="https://sarmaaya.pk/img/fav.png" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://sarmaaya.pk/img/fav-apple.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://sarmaaya.pk/img/fav-apple-ratina.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://sarmaaya.pk/img/fav-apple-ratina.png">
  <title>KSE100 Distribution</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>


<style>

  .containerPallet{
    font-family: sans-serif;
    text-align: center;
    display: flex;
    justify-content: flex-end;
    flex-direction: row;
    margin-top: 50px;
  }
  p {
    width: 50px;
    height: 40px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 15px;
    margin: 0px;
  }
  #id1{
    background-color: #DD2E2E;
  }
  #id2{
    background-color: #A00C0C ;
  }
  #id3{
    background-color: #5C0808;
  }
  #id5{
    background-color: #188518 ;
  }
  #id6{
    background-color: #519B57 ;
  }
  #id7{
    background-color: #63C668;
  }
  #id4{
    background-color: grey;
  }
</style>

<style>
  .tooltip {
    display:inline-block;
    position:relative;
    border-bottom:1px dotted #666;
    text-align:left;
  }

  .tooltip h3 {margin:12px 0;}

  .tooltip .left {
    min-width:200px;
    max-width:400px;
    top:50%;
    right:100%;
    margin-right:20px;
    transform:translate(0, -50%);
    padding:20px;
    color:#666666;
    background-color:#FFFFE0;
    font-weight:normal;
    font-size:13px;
    border-radius:8px;
    position:absolute;
    z-index:99999999;
    box-sizing:border-box;
    display:none;
    border:1px solid #DCA;
  }

  .tooltip:hover .left {
    display:block;
  }

  .tooltip .left i {
    position:absolute;
    top:50%;
    left:100%;
    margin-top:-12px;
    width:12px;
    height:24px;
    overflow:hidden;
  }

  .tooltip .left i::after {
    content:'';
    position:absolute;
    width:12px;
    height:12px;
    left:0;
    top:50%;
    transform:translate(-50%,-50%) rotate(-45deg);
    background-color:#FFFFE0;
    border:1px solid #DCA;
  }


</style>



<body id="slider">

<div class="container">

  <div class="row">

    <div class="col-md-5 offset-md-4 mt-3 bg-light p-2 border rounded shadow-sm">

      <div id="SunBurstChart"></div>

      <div class="containerPallet">
        <p id="id1">-7.5%</p>
        <p id="id2">-5%</p>
        <p id="id3">-2.5%</p>
        <p id="id4">0%</p>
        <p id="id5">+2.5%</p>
        <p id="id6">+5%</p>
        <p id="id7">+7.5%</p>

      </div>

    </div>

  </div>

</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  var session_user_id = "11559";
  var chart_type = 'today';
  var formdata = new FormData();
  formdata.append("user_id", session_user_id);
  var requestOptions = {
    method: "POST",
    mode: 'cors',
    body: formdata,
    redirect: "follow",
  };


  // fetch("https://sarmaaya.pk/api_prod/3.0/view_sunburst_portfolio.php", requestOptions)

  fetch("http://63.35.243.243/api/3.0/view_sunburst_portfolio.php",requestOptions)
          .then((response) => response.json())
          .then((data)=>{
            console.log('dd',data);
            // console.log('today_pl_percent', data.data[0].stocks["today_pl_percent"]);
            // console.log('total_pop_pl_percent', data.data[0].stocks["total_pop_pl_tage"]);
            // if (chart_type == 'total') {
            //   for (var i = 0; i < data.data.length; i++) {
            //     data.data[i].stocks['today_pl_percent'] = data.data[i].stocks['total_pop_pl_tage'];
            //   }
            // }
            sunApiData(data)
          })

          .catch((error) => console.log("error", error));


  function sunApiData(data) {



    console.log("data", data);
    // data.data[4].stocks["today_pl_percent"] = '0.24';
    // console.log(data.data[4].stocks["today_pl_percent"]);
    // total_pop_pl_tage

    var today_array = [];
    for (var i = 0; i < data.data.length; i++) {
      today_array.push(data.data[i].stocks["today_pl_percent"]);
    }

    // if (chart_type == "total") {
    //   for (var i = 0; i < data.data.length; i++) {
    //     data.data[i].stocks["today_pl_percent"] = data.data[i].stocks["total_pop_pl_tage"];
    //   }
    //
    //   // for (var i = 0; i < data.data.length; i++) {
    //   //   data.data[i].stocks["today_pl_percent"] = today_array[i];
    //   // }
    // }

    data.portfolio_today_pl_percent =
            data.portfolio_today_pl_percent.toFixed(2);
    data.username = data.username.substring(0, 10);
    for (var i = 0; i < data.data.length; i++) {
      data.data[i].sector_name = data.data[i].sector_name.substring(0, 10);
      delete data.data[i].stocks.weightage;
    }

    for (var i = 0; i < data.data.length; i++) {
      data.data[i].stocks["weightage"] = Math.abs(
              data.data[i].stocks.portfolio_percentage
      );
    }
    for (var i = 0; i < data.data.length; i++) {
      delete data.data[i].stocks.sector_name;
    }

    all_SC = [];
    all_SN = [];

    for (var i = 0; i < data.data.length; i++) {
      if (all_SC.indexOf(data.data[i].sector_code) == -1) {
        all_SC.push(data.data[i].sector_code);
        all_SN.push(data.data[i].sector_name);
      }
    }
    for (let i = 0; i < all_SC.length; i++) {
      all_SC[i] = {
        sector_code: all_SC[i],
        sector_name: all_SN[i],
        portfolio_percentage: 0,
        stocks: [],
      };
    }
    for (var i = 0; i < data.data.length; i++) {
      const index = all_SC
              .map((object) => object.sector_code)
              .indexOf(data.data[i].sector_code);
      all_SC[index].stocks.push(data.data[i].stocks);
      if (
              data.data[i].portfolio_percentage >
              all_SC[index].portfolio_percentage
      ) {
        all_SC[index].portfolio_percentage =
                data.data[i].portfolio_percentage;
      }
    }
    data = {
      status: data.status,
      username: data.username,
      cash_balance: data.cash_balance,
      portfolio_today_pl: data.portfolio_today_pl,
      portfolio_today_pl_percent: data.portfolio_today_pl_percent,
      portfolio_market_value: data.portfolio_market_value,
      portfolio_capital_invested: data.portfolio_capital_invested,
      portfolio_total_unrealized_pl: data.portfolio_total_unrealized_pl,
      portfolio_total_unrealized_pl_tage:
      data.portfolio_total_unrealized_pl_tage,
      data: all_SC,
    };
    // console.log("finData", data);
    /* for (var i = 0; i < data.data.length; i++) {
      data.data[i].sector_name = data.data[i].sector_name.substring(0, 10);
    }*/
      // const keys = {
      //   username: "name",
      //   sector_name: "name",
      //   data: "children",
      //   stocks: "children",
      //   stock_symbol: "name",
      //   weightage: "value",
      //   stock_change_p: "points",
      //   portfolio_today_pl_percent: "points",
      //   today_pl_percent: "points",
      //   portfolio_percentage: "points",
      // };

    let keys;
    if(chart_type=='today'){
      // console.log('cc1',chart_type)

      keys = {
        username: "name",
        sector_name: "name",
        data: "children",
        stocks: "children",
        stock_symbol: "name",
        weightage: "value",
        stock_change_p: "points",
        portfolio_today_pl_percent: "points",
        today_pl_percent: "points",
        portfolio_percentage: "points",
      };
    }
    else{
      keys = {
        username: "name",
        sector_name: "name",
        data: "children",
        stocks: "children",
        stock_symbol: "name",
        weightage: "value",
        stock_change_p: "total_points",
        portfolio_today_pl_percent: "total_points",
        total_profit_percentage: "total_points",
        portfolio_percentage: "total_points",
      };

    }
    const rename = (value) => {
      if (!value || typeof value !== "object") return value;
      if (Array.isArray(value)) return value.map(rename);
      return Object.fromEntries(
              Object.entries(value).map(([k, v]) => [keys[k] || k, rename(v)])
      );
    };
    data = rename(data);
    console.log("rename", data);

    chart = () => {
      marketName = data.name;
      // console.log(data.name)
      marketChange = data.points;
      var color = d3.scaleOrdinal();

      const root = partition(data);

      root.each((d) => (d.current = d));

      const svg = d3
              .create("svg")
              .attr("viewBox", [0, 0, width, width])
              .style("font", "28px sans-serif")
              .style("fontWeight", "bold");
      //  .style('fill', 'black')

      const g = svg
              .append("g")
              .attr("transform", `translate(${width / 2},${width / 2})`);

      const path = g
              .append("g")
              .selectAll("path")
              .data(root.descendants().slice(1))
              .join("path")
              .attr("fill", function (d, i, value) {
                if (chart_type == "today") {
                  if (d.data.points == 0) {
                    return "#84C58";
                  } else if (d.data.points < 0 && d.data.points > -2.5) {
                    return "#5C0808";
                  } else if (d.data.points < -2.5 && d.data.points > -5) {
                    return "#A00C0C";
                  } else if (d.data.points < -5 && d.data.points > -20) {
                    return "#DD2E2E";
                  } else if (d.data.points > 0 && d.data.points < 2.5) {
                    return "#188518";
                  } else if (d.data.points > 2.5 && d.data.points < 5) {
                    return "#519B57";
                  } else if (d.data.points > 5 && d.data.points < 20) {
                    return "#63C668";
                  } else if (d.data.points > 20) {
                    return "#2F912F";
                  } else if (d.data.points < -20) {
                    return "#6C2020";
                  }
                }
                else {
                  if (d.data.points == 0) {
                    return "#84C58";
                  } else if (d.data.total_points < 0 && d.data.total_points > -2.5) {
                    return "#5C0808";
                  } else if (d.data.total_points < -2.5 && d.data.total_points > -5) {
                    return "#A00C0C";
                  } else if (d.data.total_points < -5 && d.data.total_points > -20) {
                    return "#DD2E2E";
                  } else if (d.data.total_points > 0 && d.data.total_points < 2.5) {
                    return "#188518";
                  } else if (d.data.total_points > 2.5 && d.data.total_points < 5) {
                    return "#519B57";
                  } else if (d.data.total_points > 5 && d.data.total_points < 20) {
                    return "#63C668";
                  } else if (d.data.total_points > 20) {
                    return "#2F912F";
                  } else if (d.data.total_points < -20) {
                    return "#6C2020";
                  }
                }

              })
              .attr("fill-opacity", (d) =>
                      arcVisible(d.current) ? (d.value ? 1 : 1) : 1
              )
              .attr("d", (d) => arc(d.current))
              .text((d) => (d.data.value < 1.4 ? " " : d.data.fff))
              .text((d) => (d.value < 1.4 ? " " : d.data.name));

      path
              .filter((d) => d.children)
              .style("cursor", "pointer")
              .on("click", clicked);

      path.append("title").text(
              (d) => `${d
                      .ancestors()
                      .map((d) => d.data.name)
                      .reverse()
                      .join(">")}:\nTotal Percentage Allocation: ${parseFloat(
                      d.value
              ).toFixed(2)}%\nToday P/L Percentage: ${parseFloat(
                      d.data.points
              )}%   \nTotal Profit Percentage: ${
                      d.data.total_profit_percentage
              }%\nTotal Number of Shares: ${
                      d.data.qty_available
              }\nTotal Profit/Loss In rupees: Rs ${d.data.today_pl}`);



      path.append("info").text(
              (d) =>
                      `${d
                              .ancestors()
                              .map((d) => d.data.size)
                              .reverse()
                              .join("/")} \n${format(d.value)} `
      );

      const label = g
              .append("g")

              .attr("pointer-events", "none")
              .attr("text-anchor", "middle")
              .style("user-select", "none")
              .selectAll("text")
              .data(root.descendants().slice(1))
              .join("text")
              .attr("dy", "0.35em")
              .style("fill", "white")
              .attr("fill-opacity", (d) => +labelVisible(d.current))
              .text((d) => d.data.name + "\n" + d.data.value)
              .attr("transform", (d) => labelTransform(d.current))
              .text((d) => d.data.name)

              .text((d) => d.data.name);

      const parent = g
              .append("circle")
              .datum(root)
              .attr("r", radius)
              .attr("fill", "red")
              .attr("pointer-events", "all")

              .on("click", clicked)

              .attr("fill", function (d, i, value) {
                if (chart_type == "today") {
                  if (d.data.points > 0) {
                    return "#2F912F";
                  } else if (d.data.points == 0) {
                    return "#84C58";
                  } else if (d.data.points < 0) {
                    return "#6C2020";
                  }
                }
                else {
                  if (d.data.total_points > 0) {
                    return "#2F912F";
                  } else if (d.data.total_points == 0) {
                    return "#84C58";
                  } else if (d.data.total_points < 0) {
                    return "#6C2020";
                  }
                }

              });

      const title = g
              .append("text")
              .text(`${marketName}: ${marketChange}%`)
              .attr("text-anchor", "middle")
              .attr("alignment-baseline", "middle")
              .style("font-size", "38px")
              .attr("fill", "white")
              .style("font-weight", "bold")
              .style("cursor", "default");
      path.append("title").text("points");

      function clicked(event, p) {
        parent.datum(p.parent || root);

        root.each(
                (d) =>
                        (d.target = {
                          x0:
                                  Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) *
                                  2 *
                                  Math.PI,
                          x1:
                                  Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) *
                                  2 *
                                  Math.PI,
                          y0: Math.max(0, d.y0 - p.depth),
                          y1: Math.max(0, d.y1 - p.depth),
                        })
        );

        const t = g.transition().duration(800);

        path
                .transition(t)
                .tween("data", (d) => {
                  const i = d3.interpolate(d.current, d.target);
                  return (t) => (d.current = i(t));
                })
                .filter(function (d) {
                  return (
                          +this.getAttribute("fill-opacity") || arcVisible(d.target)
                  );
                })
                .attr("fill-opacity", (d) =>
                        arcVisible(d.target) ? (d.children ? 1 : 1) : 1
                )
                .attrTween("d", (d) => () => arc(d.current));

        label
                .filter(function (d) {
                  return (
                          +this.getAttribute("fill-opacity") || labelVisible(d.target)
                  );
                })
                .transition(t)
                .attr("fill-opacity", (d) => +labelVisible(d.target))
                .attrTween("transform", (d) => () => labelTransform(d.current));
      }

      function arcVisible(d) {
        return d.y1 <= 3 && d.y0 >= 1 && d.x1 > d.x0;
      }

      function labelVisible(d) {
        return (
                d.y1 <= 3 && d.y0 >= 1 && (d.y1 - d.y0) * (d.x1 - d.x0) > 0.03
        );
      }

      function labelTransform(d) {
        const x = (((d.x0 + d.x1) / 2) * 180) / Math.PI;
        const y = ((d.y0 + d.y1) / 2) * radius;
        return `rotate(${x - 90}) translate(${y}, 0) rotate(${
                x < 180 ? 0 : 180
        })`;
      }

      return svg.node();
    };

    partition = (data) => {
      const root = d3
              .hierarchy(data)
              .sum((d) => d.value)
              .sort((a, b) => b.value - a.value);
      return d3.partition().size([2 * Math.PI, root.height + 1])(root);
    };

    format = d3.format(",d");
    width = 1300;
    radius = width / 6;
    arc = d3
            .arc()
            .startAngle((d) => d.x0)
            .endAngle((d) => d.x1)
            .padAngle((d) => Math.min((d.x1 - d.x0) / 2, 0.005))
            .padRadius(radius * 1.5)
            .innerRadius((d) => d.y0 * radius)
            .outerRadius((d) => Math.max(d.y0 * radius, d.y1 * radius - 1));





    const svg = d3.select("#SunBurstChart").append(chart);

  };

</script>
</body>

</html>